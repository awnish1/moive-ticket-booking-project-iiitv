<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Theaters & Showtimes</title> <link rel="stylesheet" href="movie-details.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Styles for the full-width banner */
        #movie-banner {
            width: 100%;
            height: 45vh; /* Adjust height as needed */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            margin-bottom: 1.5rem; /* Space below banner */
            position: relative; /* Needed for absolute positioning inside */
            background-color: #111; /* Fallback background */
        }

        /* Keep other sections constrained */
        .content-wrapper {
             max-width: 1100px;
             margin: 0 auto;
             padding: 0 2rem; /* Add horizontal padding */
        }

        /* Back button positioned over banner */
        .back-button-container {
            position: absolute;
            top: 0; left: 0; right: 0;
            max-width: 1100px; /* Align with content */
            margin: 0 auto; /* Center */
            background: none; box-shadow: none;
            padding: 1rem 2rem;
            z-index: 10; /* Ensure it's above banner */
        }
        .back-button-container .back-btn { /* Style for visibility on banner */
             color: white;
             text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }


        /* Styling for title/meta placed below banner */
        #movie-title-meta {
             text-align: center;
             margin-bottom: 1.5rem;
             padding: 1rem 0; /* Add some padding */
        }
         #movie-title-meta h1 {
             color: #ffffff; font-size: 2.4em; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.2;
         }
         #movie-title-meta .info-meta {
             color: #ccc; font-size: 0.95em; display: flex; justify-content: center; gap: 0.5rem 1rem; flex-wrap: wrap;
         }
         #movie-title-meta .info-meta span {
             background-color: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.6rem; border-radius: 4px; white-space: nowrap;
         }

        /* Ensure loading/error messages are visible */
        .loading-message { color: #ccc; text-align: center; padding: 1.5rem; font-style: italic; }
        .error-message { color: #e74c3c; font-weight: bold; text-align: center; padding: 1.5rem; }

        /* Styles for theater list and fixed slots */
        .theater-group { cursor: pointer; } /* Keep theaters clickable */
        .theater-group:hover { background-color: rgba(255, 255, 255, 0.05); }
        .theater-group.selected { /* Style for selected theater */
            background-color: rgba(205, 140, 56, 0.1);
            border-left: 4px solid #cd8c38;
         }
         /* Styling for fixed showtime buttons */
         .fixed-showtime-slot {
            background-color: #3f3f3f; color: #e8e8e8; border: 1px solid #5f5f5f;
            padding: 0.6rem 1.1rem; border-radius: 5px; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s; font-size: 1em; margin: 5px; display: inline-block;
         }
         .fixed-showtime-slot:hover { background-color: #555; transform: translateY(-1px); }
         /* Style for selected fixed slot */
         .fixed-showtime-slot.selected {
             background-color: #cd8c38; color: #1e1f26; border-color: #b87b2a;
             font-weight: bold; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); transform: none;
         }
         #fixed-showtimes-list { margin-top: 1rem; text-align: center; }
         .showtimes-container { text-align: center; } /* Centers proceed button */

    </style>
</head>
<body>
    <div id="movie-banner">
        <div class="back-button-container">
            <a href="index.html" id="back-link" class="back-btn" aria-label="Back to movie list" style="display: none;">‚Üê Back to Movies</a>
        </div>
    </div>

    <div class="content-wrapper">

        <section id="movie-title-meta">
             <p class="loading-message">Loading movie details...</p>
        </section>

        <section class="selection-container">
            <div class="select-date">
               <h2>Select Date</h2>
               <div id="date-options"> <p class="loading-message">Loading dates...</p> </div>
            </div>
           <div class="select-lang-format">
               <h2>Select Language & Format</h2>
                <div id="lang-format-options"> <p class="loading-message">Loading options...</p> </div>
           </div>
           <div class="select-location">
               <h2>Select Location</h2>
               <select id="location-select" name="location" aria-label="Select your location">
                   <option value="">-- Choose a Location --</option>
                   <option value="Patna">Patna</option>
                   <option value="Mumbai">Mumbai</option>
                   <option value="Delhi">Delhi</option>
                   <option value="Noida">Noida</option>
                   <option value="Gurgaon">Gurgaon</option>
                   <option value="Bangalore">Bangalore</option>
                   <option value="Hyderabad">Hyderabad</option>
                   <option value="Gandhinagar">Gandhinagar</option>
                   </select>
           </div>
        </section>

        <section class="theater-display-container">
            <h2 id="theater-display-heading">Available Theaters</h2>
            <div id="theater-list">
                <p id="theater-instructions">Select location above.</p>
            </div>
        </section>

        <section class="showtimes-container" id="fixed-showtimes-container" style="display: none;"> <h2 id="showtimes-heading">Select Showtime Slot</h2>
             <div id="fixed-showtimes-list">
                   </div>
             <button id="proceed-button" class="btn" style="margin-top: 1rem; display: none;">Proceed to Seat Selection</button>
        </section>

    </div> <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Config & DOM Refs ---
            const API_BASE_URL = 'http://localhost:3000';
            const movieBannerEl = document.getElementById('movie-banner');
            const movieTitleMetaEl = document.getElementById('movie-title-meta');
            const dateOptionsEl = document.getElementById('date-options');
            const langFormatOptionsEl = document.getElementById('lang-format-options');
            const locationSelectEl = document.getElementById('location-select');
            const theaterListEl = document.getElementById('theater-list');
            const theaterInstructionsEl = document.getElementById('theater-instructions');
            const fixedShowtimesContainer = document.getElementById('fixed-showtimes-container');
            const fixedShowtimesListEl = document.getElementById('fixed-showtimes-list');
            const proceedButton = document.getElementById('proceed-button');
            const backLink = document.getElementById('back-link');

            // --- State Variables ---
            let selectedMovie = null;
            let selectedDate = null;
            let selectedLanguage = null;
            let selectedFormat = null;
            let selectedLocation = null;
            let selectedTheaterId = null;
            let selectedShowtimeSlot = null; // Stores the 'value' (e.g., "Morning")

            // Fixed Showtime Slots
            const FIXED_SHOWTIMES = [
                { label: "9:00 AM - 12:00 PM", value: "Morning" },
                { label: "1:00 PM - 5:00 PM", value: "Afternoon" },
                { label: "8:00 PM - 11:00 PM", value: "Evening" }
            ];

            // --- Get Movie ID & Initial Setup ---
            const params = new URLSearchParams(window.location.search);
            const movieId = params.get('id');
            if (!movieId) { displayError("Error: Movie ID missing.", document.body); return; }
            backLink.href = `index.html`;
            backLink.style.display = 'inline-block'; // Show back link

            // --- Core Functions ---

            async function fetchAndDisplayMovieDetails() {
                 setLoadingMessage("Loading movie details...", movieTitleMetaEl);
                 try {
                     const response = await fetch(`${API_BASE_URL}/api/movies/${movieId}`);
                     if (!response.ok) {
                         const errText = await response.text();
                         throw new Error(`Server error (${response.status}): ${errText}`);
                     }
                     selectedMovie = await response.json();
                     if (!selectedMovie) throw new Error("Movie data not found after fetch.");

                     displayMovieDetails(selectedMovie);
                     populateDateButtons();
                     populateLangFormatOptions(selectedMovie.languages, selectedMovie.formats);
                 } catch (error) {
                      displayError(`Could not load movie details: ${error.message}`, movieTitleMetaEl);
                      console.error("Error fetching movie details:", error);
                      // Optionally hide other loading sections if movie fails to load
                      langFormatOptionsEl.innerHTML = '<p class="error-message">Cannot load options.</p>';
                      dateOptionsEl.innerHTML = '<p class="error-message">Cannot load dates.</p>';
                 }
            }

            function displayMovieDetails(movie) {
                movieTitleMetaEl.innerHTML = ''; // Clear loading message
                const title = movie.title || 'Untitled Movie';
                document.title = `Theaters for ${title}`;

                // Set Banner Image
                const bannerSrc = movie.bannerUrl || movie.imageUrl || '';
                movieBannerEl.style.backgroundImage = bannerSrc ? `url('${bannerSrc}')` : 'none';
                if (!bannerSrc) movieBannerEl.style.backgroundColor = '#222'; // Fallback

                // Populate Title and Meta Info
                const duration = movie.duration || '--';
                const certification = movie.certification || 'N/A';
                const ratingStr = typeof movie.rating === 'number' ? `${movie.rating.toFixed(1)}/10` : 'N/A';

                movieTitleMetaEl.innerHTML = `
                    <h1>${title}</h1>
                    <div class="info-meta">
                        <span>${duration}</span> | <span>${certification}</span> | <span>Rating: ${ratingStr}</span>
                    </div>
                    `;
            }

            function populateDateButtons() {
                 dateOptionsEl.innerHTML = '';
                 const today = new Date();
                 for (let i = 0; i < 7; i++) {
                     const date = new Date(today); date.setDate(today.getDate() + i);
                     const year = date.getFullYear();
                     const month = String(date.getMonth() + 1).padStart(2, '0');
                     const day = String(date.getDate()).padStart(2, '0');
                     const dateString = `${year}-${month}-${day}`;

                     const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                     const dayOfMonth = date.getDate();
                     const btn = document.createElement('button');
                     btn.className = 'date-btn'; btn.dataset.date = dateString;
                     btn.innerHTML = `${dayName}<br>${dayOfMonth}`;
                     btn.setAttribute('aria-label', `Select date ${date.toLocaleDateString()}`);
                     btn.addEventListener('click', handleDateSelect);
                     // Set default selected date state correctly
                     if (i === 0) {
                         btn.classList.add('active');
                         selectedDate = dateString; // Ensure state is set on load
                     }
                     dateOptionsEl.appendChild(btn);
                 }
            }

            function populateLangFormatOptions(languages = [], formats = []) {
                 langFormatOptionsEl.innerHTML = '';
                 if (!languages || languages.length === 0 || !formats || formats.length === 0) {
                      langFormatOptionsEl.innerHTML = '<p>No viewing options available.</p>'; return;
                 }
                 let isFirstOption = true;
                 languages.forEach(lang => { formats.forEach(format => {
                     const btn = document.createElement('button'); btn.className = 'lang-format-btn';
                     btn.textContent = `${lang} - ${format}`;
                     btn.dataset.language = lang; btn.dataset.format = format;
                     btn.setAttribute('aria-label', `Select ${lang} ${format}`);
                     btn.addEventListener('click', handleLangFormatSelect);
                     // Set default selected language/format state correctly
                     if (isFirstOption) {
                         btn.classList.add('active');
                         selectedLanguage = lang; // Ensure state is set on load
                         selectedFormat = format; // Ensure state is set on load
                         isFirstOption = false;
                     }
                     langFormatOptionsEl.appendChild(btn);
                 }); });
                 // Don't fetch theaters yet, wait for location
            }

            // --- Event Handlers ---

            function handleDateSelect(event) {
                selectedDate = event.currentTarget.dataset.date;
                document.querySelectorAll('#date-options .date-btn.active').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                clearFixedShowtimes();
                selectedShowtimeSlot = null;
                proceedButton.style.display = 'none';
            }

            function handleLangFormatSelect(event) {
                selectedLanguage = event.currentTarget.dataset.language;
                selectedFormat = event.currentTarget.dataset.format;
                document.querySelectorAll('#lang-format-options .lang-format-btn.active').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                clearFixedShowtimes();
                selectedShowtimeSlot = null;
                proceedButton.style.display = 'none';
            }

            locationSelectEl.addEventListener('change', (event) => {
                 selectedLocation = event.target.value;
                 clearTheatersListSelection();
                 clearFixedShowtimes();
                 if(selectedLocation) {
                     fetchRelevantTheatersIfReady();
                 } else {
                     clearTheaters();
                     theaterInstructionsEl.textContent = "Please select location.";
                 }
            });

             function handleTheaterGroupClick(event) {
                 const theaterGroup = event.target.closest('.theater-group');
                 if (!theaterGroup) return;
                 selectedTheaterId = theaterGroup.dataset.theaterId;
                 selectedShowtimeSlot = null;
                 document.querySelectorAll('#theater-list .theater-group.selected').forEach(div => div.classList.remove('selected'));
                 theaterGroup.classList.add('selected');
                 displayFixedShowtimeSlots();
             }

             function handleFixedSlotClick(event) {
                 const slotButton = event.currentTarget;
                 selectedShowtimeSlot = slotButton.dataset.slotValue;
                 document.querySelectorAll('#fixed-showtimes-list .fixed-showtime-slot.selected').forEach(btn => btn.classList.remove('selected'));
                 slotButton.classList.add('selected');
                 proceedButton.style.display = 'inline-block';
             }

             proceedButton.addEventListener('click', async () => {
                if (!selectedMovie || !selectedTheaterId || !selectedLanguage || !selectedFormat || !selectedDate || !selectedShowtimeSlot) {
                    alert("Please ensure movie, theater, language, format, date, and showtime slot are selected.");
                    return;
                }
                const bookingData = {
                    // userId: localStorage.getItem('userId') || 'USER_ID_PLACEHOLDER', // Example
                    movieId: selectedMovie._id,
                    theaterId: selectedTheaterId,
                    language: selectedLanguage,
                    format: selectedFormat,
                    bookingDate: selectedDate,
                    showtimeSlot: selectedShowtimeSlot,
                    // seats: [], // From next step
                    // totalPrice: 0 // From next step
                };
                 // alert(`Ready to proceed to seat selection (Not Implemented)\nData:\n${JSON.stringify(bookingData, null, 2)}`); // Optional: Keep for debugging
                 // Navigate to seating page with parameters
                 const urlParams = new URLSearchParams({
                     movieId: bookingData.movieId,
                     theaterId: bookingData.theaterId,
                     date: bookingData.bookingDate,
                     slot: bookingData.showtimeSlot,
                     lang: bookingData.language,
                     format: bookingData.format,
                     // Pass movie title & theater name for display on next page
                     movieTitle: encodeURIComponent(selectedMovie.title || 'Movie'),
                     theaterName: encodeURIComponent(document.querySelector(`.theater-group[data-theater-id="${selectedTheaterId}"] h3`)?.textContent || 'Theater')
                     // Add price per seat if needed for next page calculation
                 }).toString();
                 window.location.href = `seating.html?${urlParams}`; // Navigate to seating page
             });

            // --- Fetch Theaters (Location Only) ---
            function fetchRelevantTheatersIfReady() {
                if (selectedLocation) {
                    const params = { selectedLocation };
                    fetchRelevantTheaters(params);
                } else {
                    clearTheaters();
                    theaterInstructionsEl.textContent = "Select location above.";
                }
            }

            async function fetchRelevantTheaters(params) {
                setLoadingMessage("Loading relevant theaters...", theaterListEl);
                theaterInstructionsEl.style.display = 'none';
                clearFixedShowtimes();
                const queryParams = new URLSearchParams(params);
                const apiUrl = `${API_BASE_URL}/api/theaters/relevant?${queryParams.toString()}`;
                try {
                    const response = await fetch(apiUrl);
                     if (!response.ok) {
                         const errText = await response.text();
                         throw new Error(`Server error (${response.status}): ${errText}`);
                     }
                    const theaters = await response.json();
                    displayRelevantTheaters(theaters);
                } catch (error) {
                     displayError(`Could not load theaters: ${error.message}`, theaterListEl);
                     console.error("Error fetching theaters:", error);
                }
            }

            function displayRelevantTheaters(theaters) {
                 theaterListEl.innerHTML = '';
                 if (!theaters || theaters.length === 0) {
                     theaterListEl.innerHTML = '<p class="message">No theaters found in the selected location.</p>';
                     return;
                 }
                 theaters.forEach(theater => {
                     const div = document.createElement('div');
                     div.className = 'theater-group';
                     div.dataset.theaterId = theater._id;
                     div.setAttribute('role', 'button'); div.setAttribute('tabindex', '0');
                     div.innerHTML = `<h3>${theater.name || 'Unknown Theater'}</h3>
                                      ${theater.address ? `<p class="theater-address">${theater.address}</p>` : ''}`;
                     div.addEventListener('click', handleTheaterGroupClick);
                     div.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleTheaterGroupClick(e); } });
                     theaterListEl.appendChild(div);
                 });
            }

            // Display Fixed Slots
            function displayFixedShowtimeSlots() {
                fixedShowtimesListEl.innerHTML = '';
                FIXED_SHOWTIMES.forEach(slot => {
                    const button = document.createElement('button');
                    button.className = 'fixed-showtime-slot';
                    button.textContent = slot.label;
                    button.dataset.slotValue = slot.value;
                    button.setAttribute('aria-label', `Select slot ${slot.label}`);
                    button.addEventListener('click', handleFixedSlotClick);
                    fixedShowtimesListEl.appendChild(button);
                });
                fixedShowtimesContainer.style.display = 'block';
                proceedButton.style.display = 'none';
            }


            // --- Utility Functions ---
            function setLoadingMessage(message, container) { if(container) container.innerHTML = `<p class="loading-message">${message}</p>`; }
            function displayError(message, container) { if(container) container.innerHTML = `<p class="error-message">${message}</p>`; }
            function clearTheaters() {
                theaterListEl.innerHTML = '';
                theaterInstructionsEl.textContent = "Select location above.";
                theaterInstructionsEl.style.display = 'block';
                clearFixedShowtimes();
            }
            function clearTheatersListSelection() {
                 document.querySelectorAll('#theater-list .theater-group.selected').forEach(div => div.classList.remove('selected'));
                 selectedTheaterId = null;
                 clearFixedShowtimes();
            }
            function clearFixedShowtimes() {
                 fixedShowtimesListEl.innerHTML = '';
                 fixedShowtimesContainer.style.display = 'none';
                 proceedButton.style.display = 'none';
                 selectedShowtimeSlot = null;
            }

            // --- Initial Load ---
            fetchAndDisplayMovieDetails();

        }); // End DOMContentLoaded
    </script>
</body>
</html>